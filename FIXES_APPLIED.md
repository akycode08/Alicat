# Применённые исправления

## Дата: 2026-01-07

### ❌ Изменение 1: Heartbeat в CSV (ОТКАТ)

**Файл**: `Services/Data/SessionDataStore.cs`

**Статус**: Откачено по запросу пользователя

**Текущее состояние**:
```csharp
private const double CsvHeartbeatSec = 0.0; // 0 = выключить, запись только при изменении >= CsvDelta
```

**Эффект**:
- CSV записывает только при изменении давления >= 0.3 PSI (как было раньше)
- Это экономит место на диске и соответствует ожиданиям пользователя

---

### ✅ Изменение 2: Увеличен Connection Timeout

**Файл**: `Presentation/Presenters/MainPresenter.cs`

**Изменение**:
```csharp
// Было:
private const int ConnectionTimeoutMs = 5000; // 5 секунд

// Стало:
private const int ConnectionTimeoutMs = 30000; // 30 секунд
```

**Эффект**:
- Устройство может не отвечать до 30 секунд перед отключением (вместо 5)
- Это даст больше времени для восстановления связи при временных проблемах
- Особенно важно для длительных тестов (7+ часов)

---

### ✅ Изменение 3: Добавлено логирование для диагностики

**Файлы**: 
- `Presentation/Presenters/MainPresenter.cs` (WatchdogTimerCallback)
- `Services/Serial/SerialClient.cs` (Send, Dispose)

**Добавлено логирование**:
1. **Watchdog Timer**: Логирует срабатывание таймера и причину отключения
2. **SerialClient.Send**: Логирует отправку команд и ошибки
3. **SerialClient.Dispose**: Логирует закрытие порта и вызов события Disconnected

**Эффект**:
- В Debug Output (Visual Studio) теперь будет видно:
  - Когда и почему сработал watchdog timer
  - Когда устройство перестало отвечать
  - Все отправленные команды
  - Все закрытия соединения

**Как использовать**:
- Откройте Output Window в Visual Studio (View → Output)
- Выберите "Debug" в выпадающем списке
- Все логи будут видны с временными метками

---

## Ожидаемые результаты

### Polling Frequency
- **Текущее состояние**: Интервалы 1-2 секунды в CSV (только при изменении >= 0.3 PSI) - это нормальное поведение
- **Опрос устройства**: Остаётся 500 мс (не изменилось)
- **Запись в CSV**: Только при изменении давления >= 0.3 PSI (как было раньше)

### Device Disconnected
- **До**: Отключение через 5 секунд без ответа
- **После**: Отключение через 30 секунд без ответа
- **Диагностика**: Полное логирование всех событий отключения

---

## Рекомендации для следующего теста

1. **Включите Debug Output** в Visual Studio для просмотра логов
2. **Сохраните логи** после завершения теста для анализа
3. **Проверьте**:
   - Равномерность записей в CSV (должны быть записи каждые 10 сек)
   - Причину отключения (если произойдёт) в логах
   - Время последнего ответа от устройства перед отключением

---

## Дополнительные улучшения (опционально)

Если проблемы сохранятся, можно рассмотреть:

1. **Автоматическое переподключение** при обнаружении отключения
2. **Периодическая проверка состояния COM порта** (каждые 5 минут)
3. **Увеличение ReadTimeout/WriteTimeout** в настройках COM порта
4. **Heartbeat с настраиваемым интервалом** через UI

---

## Откат изменений

Если нужно вернуться к предыдущему поведению:

1. **Timeout**: Изменить `ConnectionTimeoutMs = 5000` в `MainPresenter.cs` (если нужно вернуть 5 секунд)
2. **Логирование**: Можно оставить (не влияет на работу, только помогает диагностике)
3. **Heartbeat**: Уже отключен (0.0) - запись только при изменении

