# Анализ проблем: Polling Frequency и Device Disconnected

## Дата анализа
2026-01-07

## Резюме проблем

1. **Расхождение Polling Frequency**: Фактический интервал между записями в CSV (~1.3 сек) больше настройки (500 мс)
2. **Device Disconnected**: Устройство отключается после завершения 7-часового теста

---

## Проблема 1: Расхождение Polling Frequency

### Обнаруженная ситуация
- **Настройка**: 500 мс
- **Фактическая медиана**: 1,311 мс
- **Фактическое среднее**: 1,131 мс
- **71% записей** имеют интервал 1-2 секунды

### Причина проблемы

**Это нормальное поведение системы!** Проблема не в опросе устройства, а в логике записи в CSV.

#### Как работает система:

1. **Опрос устройства** (`MainPresenter.cs`, строка 43):
   ```csharp
   private readonly Timer _pollTimer = new() { Interval = 500 };
   ```
   - Таймер опроса работает **каждые 500 мс** ✅
   - Устройство опрашивается с правильной частотой

2. **Запись в RAM** (`SessionDataStore.cs`, строка 126):
   ```csharp
   _points.Add(point); // Всегда записывается в RAM
   ```
   - Все точки записываются в память с частотой 500 мс ✅

3. **Запись в CSV** (`SessionDataStore.cs`, строки 176-202):
   ```csharp
   private const double CsvDelta = 0.3; // порог изменения
   
   private bool ShouldWriteToCsv(DataPoint p)
   {
       // CSV пишется ТОЛЬКО если изменение >= 0.3 PSI
       if (Math.Abs(p.Current - _lastCsvPoint.Current) >= CsvDelta) return true;
       if (Math.Abs(p.Target - _lastCsvPoint.Target) >= CsvDelta) return true;
       return false;
   }
   ```
   - В CSV записываются **только точки с изменением >= 0.3 PSI** ⚠️
   - Это сделано для экономии места на диске

#### Почему интервалы 1-2 секунды?

- При **рампинге** (изменение давления): запись каждые ~500 мс (когда изменение >= 0.3 PSI)
- При **удержании** (стабильное давление): запись реже, т.к. изменение < 0.3 PSI
- **71% записей** с интервалом 1-2 сек = это периоды удержания давления

### Решение

#### Вариант 1: Включить Heartbeat (рекомендуется)
Добавить периодическую запись даже без изменения давления:

```csharp
// В SessionDataStore.cs, строка 26
private const double CsvHeartbeatSec = 10.0; // Запись каждые 10 секунд
```

Это обеспечит:
- Запись при изменении >= 0.3 PSI (как сейчас)
- Дополнительную запись каждые 10 секунд для подтверждения работы

#### Вариант 2: Уменьшить порог изменения
```csharp
private const double CsvDelta = 0.1; // Вместо 0.3
```

#### Вариант 3: Записывать все точки в CSV
Убрать фильтрацию по изменению (не рекомендуется для длительных тестов - файлы будут огромными).

---

## Проблема 2: Device Disconnected после завершения теста

### Обнаруженная ситуация
- Тест завершился успешно (102 точки)
- После последней записи (01:04:52) устройство отключилось
- Нет явной ошибки в логах

### Причина проблемы

**Вероятная причина: Watchdog Timer сработал из-за отсутствия ответов от устройства.**

#### Как работает Watchdog Timer:

1. **Инициализация** (`MainPresenter.cs`, строки 50-51):
   ```csharp
   private System.Threading.Timer? _watchdogTimer;
   private const int ConnectionTimeoutMs = 5000; // 5 секунд
   ```

2. **Сброс при получении данных** (строка 291):
   ```csharp
   ResetWatchdogTimer(); // Вызывается при каждом ответе от устройства
   ```

3. **Срабатывание при таймауте** (строки 1742-1774):
   ```csharp
   private void WatchdogTimerCallback(object? state)
   {
       // Если нет ответа 5 секунд - закрываем соединение
       _serial?.Dispose(); // Это вызывает Disconnected событие
   }
   ```

#### Почему это могло произойти?

**Гипотеза 1: Устройство перестало отвечать после завершения последовательности**
- После завершения последней точки (01:04:52) устройство могло перейти в режим ожидания
- Если устройство не отвечает на запросы `ALS` в течение 5 секунд, watchdog закрывает соединение

**Гипотеза 2: Проблема с COM портом после длительной работы**
- Windows может закрыть COM порт при длительной работе (7 часов)
- USB timeout или проблемы с драйвером

**Гипотеза 3: Устройство физически отключилось**
- Проблема с USB кабелем
- Проблема с питанием устройства

### Решение

#### Решение 1: Увеличить Connection Timeout (быстрое решение)
```csharp
// В MainPresenter.cs, строка 51
private const int ConnectionTimeoutMs = 30000; // 30 секунд вместо 5
```

Это даст больше времени для восстановления связи.

#### Решение 2: Добавить логирование отключений
```csharp
// В MainPresenter.cs, WatchdogTimerCallback
private void WatchdogTimerCallback(object? state)
{
    System.Diagnostics.Debug.WriteLine($"[{DateTime.Now:yyyy-MM-dd HH:mm:ss.fff}] Watchdog timeout - device not responding");
    // ... остальной код
}
```

#### Решение 3: Добавить автоматическое переподключение (сложное решение)
- При обнаружении отключения попытаться переподключиться
- Сохранить состояние теста перед переподключением

#### Решение 4: Проверить настройки COM порта
В `FormConnect.cs` проверить:
- `ReadTimeout` (по умолчанию 700 мс)
- `WriteTimeout` (по умолчанию 700 мс)

Для длительных тестов рекомендуется:
- `ReadTimeout = 2000` (2 секунды)
- `WriteTimeout = 2000` (2 секунды)

---

## Рекомендации

### Немедленные действия

1. **Включить Heartbeat в CSV** (10 секунд):
   ```csharp
   // SessionDataStore.cs, строка 26
   private const double CsvHeartbeatSec = 10.0; // Включить heartbeat
   ```

2. **Увеличить Connection Timeout**:
   ```csharp
   // MainPresenter.cs, строка 51
   private const int ConnectionTimeoutMs = 30000; // 30 секунд
   ```

3. **Добавить логирование** для диагностики отключений

### Долгосрочные улучшения

1. **Мониторинг состояния соединения**:
   - Показывать время последнего ответа от устройства
   - Предупреждать о возможных проблемах

2. **Улучшенная обработка ошибок**:
   - Различать типы отключений (таймаут, физическое отключение, ошибка порта)
   - Сохранять состояние перед отключением

3. **Оптимизация для длительных тестов**:
   - Периодическая проверка состояния COM порта
   - Автоматическое восстановление соединения при сбоях

---

## Выводы

### Polling Frequency
✅ **Система работает правильно**
- Опрос устройства: каждые 500 мс ✅
- Запись в RAM: каждые 500 мс ✅
- Запись в CSV: только при изменении >= 0.3 PSI (это нормально)

**Рекомендация**: Включить heartbeat для периодической записи в CSV.

### Device Disconnected
⚠️ **Требует внимания**
- Вероятная причина: Watchdog Timer (5 секунд без ответа)
- После завершения теста устройство могло перестать отвечать

**Рекомендация**: 
1. Увеличить Connection Timeout до 30 секунд
2. Добавить логирование для диагностики
3. Проверить настройки COM порта

### Стабильность системы
✅ **Тест прошёл успешно** (102 точки за 7 часов)
⚠️ **Отключение в конце** - это баг, который нужно исправить

---

## Вопросы для уточнения

1. **После отключения**:
   - Можно ли было переподключиться сразу?
   - Устройство физически отключилось или только программно?

2. **В логах устройства**:
   - Есть ли записи после 01:04:52?
   - Были ли ошибки на стороне устройства?

3. **Повторяемость**:
   - Происходит ли отключение при каждом длительном тесте?
   - Или это единичный случай?

---

## Следующие шаги

1. Применить рекомендуемые изменения (heartbeat + увеличение timeout)
2. Провести повторный тест
3. Собрать дополнительную диагностическую информацию
4. При необходимости внедрить автоматическое переподключение

